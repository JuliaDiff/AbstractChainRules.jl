<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Opting out of rules · ChainRules</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="assets/documenter.js"></script><script src="siteinfo.js"></script><script src="../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="assets/themeswap.js"></script><link href="assets/indigo.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="index.html"><img src="assets/logo.svg" alt="ChainRules logo"/></a><div class="docs-package-name"><span class="docs-autofit">ChainRules</span></div><form class="docs-search" action="search.html"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="index.html">Introduction</a></li><li><a class="tocitem" href="FAQ.html">FAQ</a></li><li><a class="tocitem" href="config.html">Rule configurations and calling back into AD</a></li><li class="is-active"><a class="tocitem" href="opting_out_of_rules.html">Opting out of rules</a><ul class="internal"><li><a class="tocitem" href="#How-to-support-this-(for-AD-implementers)"><span>How to support this (for AD implementers)</span></a></li></ul></li><li><a class="tocitem" href="writing_good_rules.html">Writing Good Rules</a></li><li><a class="tocitem" href="complex.html">Complex Numbers</a></li><li><a class="tocitem" href="arrays.html">Deriving Array Rules</a></li><li><a class="tocitem" href="debug_mode.html">Debug Mode</a></li><li><a class="tocitem" href="gradient_accumulation.html">Gradient Accumulation</a></li><li><a class="tocitem" href="use_in_ad_system.html">Usage in AD</a></li><li><a class="tocitem" href="converting_zygoterules.html">Converting ZygoteRules</a></li><li><a class="tocitem" href="tips_for_packages.html">Tips for making packages work with AD</a></li><li><span class="tocitem">Design</span><ul><li><a class="tocitem" href="design/changing_the_primal.html">Changing the Primal</a></li><li><a class="tocitem" href="design/many_differentials.html">Many Differential Types</a></li></ul></li><li><a class="tocitem" href="api.html">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href="opting_out_of_rules.html">Opting out of rules</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="opting_out_of_rules.html">Opting out of rules</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/JuliaDiff/ChainRulesCore.jl/blob/master/docs/src/opting_out_of_rules.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="opt_out"><a class="docs-heading-anchor" href="#opt_out">Opting out of rules</a><a id="opt_out-1"></a><a class="docs-heading-anchor-permalink" href="#opt_out" title="Permalink"></a></h1><p>It is common to define rules fairly generically. Often matching (or exceeding) how generic the matching original primal method is. Sometimes this is not the correct behaviour. Sometimes the AD can do better than this human defined rule. If this is generally the case, then we should not have the rule defined at all. But if it is only the case for a particular set of types, then we want to opt-out just that one. This is done with the <a href="api.html#ChainRulesCore.@opt_out-Tuple{Any}"><code>@opt_out</code></a> macro.</p><p>Consider one a <code>rrule</code> for <code>sum</code> (the following simplified from the one in <a href="https://github.com/JuliaDiff/ChainRules.jl/blob/main/src/rulesets/Base/mapreduce.jl">ChainRules.jl</a> itself)</p><pre><code class="language-julia">function rrule(::typeof(sum), x::AbstractArray{&lt;:Number})
    y = sum(x; dims=dims)
    project = ProjectTo(x)
    function sum_pullback(ȳ)
        x̄ = project(fill(ȳ, size(x)))
        return (NoTangent(), x̄)
    end
    return y, sum_pullback
end</code></pre><p>That is a fairly reasonable <code>rrule</code> for the vast majority of cases. You might have a custom array type for which you could write a faster rule. In which case you would do that, by writing a faster, more specific, <code>rrule</code>. But sometimes, it is the case that ADing the (faster, more specific) primal for your custom array type would yeild the faster pullback without you having to write a <code>rrule</code> by hand.</p><p>Consider a summing  <a href="https://en.wikipedia.org/wiki/Skew-symmetric_matrix"><code>SkewSymmetric</code> (anti-symmetric)</a> matrix. The skew symmetric matrix has structural zeros on the diagonal, and off-diagonals are paired with their negation. Thus the sum is always going to be zero. As such the author of that matrix type would probably have overloaded <code>sum(x::SkewSymmetric{T}) where T = zero(T)</code>. ADing this would result in the tangent computed for <code>x</code> as <code>ZeroTangent()</code> and it would be very fast since AD can see that <code>x</code> is never used in the right-hand side. In contrast the generic method for <code>AbstractArray</code> defined above would have to allocate the fill array, and then compute the skew projection. Only to findout the output would be projected to <code>SkewSymmetric(zeros(T))</code> anyway (slower, and a less useful type).</p><p>To opt-out of using the generic <code>rrule</code> and to allow the AD system to do its own thing we use the <a href="api.html#ChainRulesCore.@opt_out-Tuple{Any}"><code>@opt_out</code></a> macro, to say to not use it for sum of <code>SkewSymmetric</code>.</p><pre><code class="language-julia">@opt_out rrule(::typeof(sum), ::SkewSymmetric)</code></pre><p>Perhaps we might not want to ever use rules for SkewSymmetric, because we have determined that it is always better to leave it to the AD, unless a verys specific rule has been written<sup class="footnote-reference"><a id="citeref-1" href="#footnote-1">[1]</a></sup>. We could then opt-out for all 1 arg functions.</p><pre><code class="language-">@opt_out rrule(::Any, ::SkewSymmetric)</code></pre><p>Though this is likely to cause some method-ambiguities, if we do it for more, but we can resolve those.</p><p>Similar can be done  <code>@opt_out frule</code>. It can also be done passing in a <a href="config.html#config"><code>RuleConfig</code></a>.</p><div class="admonition is-warning"><header class="admonition-header">If the general rule uses a config, the opt-out must also</header><div class="admonition-body"><p>Following the same principles as for <a href="config.html#config">rules with config</a>, a rule with a <code>RuleConfig</code> argument will take precedence over one without, including if that one is a opt-out rule. But if the general rule does not use a config, then the opt-out rule <em>can</em> use a config. This allows, for example, you to use opt-out to avoid a particular AD system using a opt-out rule that takes that particular AD&#39;s config.</p></div></div><h2 id="How-to-support-this-(for-AD-implementers)"><a class="docs-heading-anchor" href="#How-to-support-this-(for-AD-implementers)">How to support this (for AD implementers)</a><a id="How-to-support-this-(for-AD-implementers)-1"></a><a class="docs-heading-anchor-permalink" href="#How-to-support-this-(for-AD-implementers)" title="Permalink"></a></h2><p>We provide two ways to know that a rule has been opted out of.</p><h3 id="rrule-/-frule-returns-nothing"><a class="docs-heading-anchor" href="#rrule-/-frule-returns-nothing"><code>rrule</code> / <code>frule</code> returns <code>nothing</code></a><a id="rrule-/-frule-returns-nothing-1"></a><a class="docs-heading-anchor-permalink" href="#rrule-/-frule-returns-nothing" title="Permalink"></a></h3><p><code>@opt_out</code> defines a <code>frule</code> or <code>rrule</code> matching the signature that returns <code>nothing</code>.</p><p>If you are in a position to generate code, in response to values returned by function calls then you can do something like:</p><pre><code class="language-">res = rrule(f, xs)
if res === nothing
    y, pullback = perform_ad_via_decomposition(r, xs)  # do AD without hitting the rrule
else
    y, pullback = res
end</code></pre><p>The Julia compiler will specialize based on inferring the return type of <code>rrule</code>, and so can remove that branch.</p><h3 id="no_rrule-/-no_frule-has-a-method"><a class="docs-heading-anchor" href="#no_rrule-/-no_frule-has-a-method"><code>no_rrule</code> / <code>no_frule</code> has a method</a><a id="no_rrule-/-no_frule-has-a-method-1"></a><a class="docs-heading-anchor-permalink" href="#no_rrule-/-no_frule-has-a-method" title="Permalink"></a></h3><p><code>@opt_out</code> also defines a method for  <a href="api.html#ChainRulesCore.no_frule"><code>ChainRulesCore.no_frule</code></a> or <a href="api.html#ChainRulesCore.no_rrule"><code>ChainRulesCore.no_rrule</code></a>. The body of this method doesn&#39;t matter, what matters is that it is a method-table. A simple thing you can do with this is not support opting out. To do this, filter all methods from the <code>rrule</code>/<code>frule</code> method table that also occur in the <code>no_frule</code>/<code>no_rrule</code> table. This will thus avoid ever hitting an <code>rrule</code>/<code>frule</code> that returns <code>nothing</code> (and thus prevents your library from erroring). This is easily done, though it does mean ignoring the user&#39;s stated desire to opt out of the rule.</p><p>More complex you can use this to generate code that triggers your AD. If for a given signature there is a more specific method in the <code>no_rrule</code>/<code>no_frule</code> method-table, than the one that would be hit from the <code>rrule</code>/<code>frule</code> table (Excluding the one that exactly matches which will return <code>nothing</code>) then you know that the rule should not be used. You can, likely by looking at the primal method table, workout which method you would have it if the rule had not been defined, and then <code>invoke</code> it.</p><section class="footnotes is-size-7"><ul><li class="footnote" id="footnote-1"><a class="tag is-link" href="#citeref-1">1</a>seems unlikely, but it is possible, there is a lot of structure that can be taken advantage of for some matrix types.</li></ul></section></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="config.html">« Rule configurations and calling back into AD</a><a class="docs-footer-nextpage" href="writing_good_rules.html">Writing Good Rules »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Saturday 9 October 2021 18:37">Saturday 9 October 2021</span>. Using Julia version 1.6.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>

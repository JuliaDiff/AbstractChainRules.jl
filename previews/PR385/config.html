<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Rule configurations and calling back into AD · ChainRules</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="assets/documenter.js"></script><script src="siteinfo.js"></script><script src="../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="assets/themeswap.js"></script><link href="assets/indigo.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="index.html"><img src="assets/logo.svg" alt="ChainRules logo"/></a><div class="docs-package-name"><span class="docs-autofit">ChainRules</span></div><form class="docs-search" action="search.html"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="index.html">Introduction</a></li><li><a class="tocitem" href="FAQ.html">FAQ</a></li><li class="is-active"><a class="tocitem" href="config.html">Rule configurations and calling back into AD</a><ul class="internal"><li><a class="tocitem" href="#Declaring-support-for-calling-back-into-ADs"><span>Declaring support for calling back into ADs</span></a></li><li><a class="tocitem" href="#Writing-rules-that-call-back-into-AD"><span>Writing rules that call back into AD</span></a></li><li><a class="tocitem" href="#Writing-rules-that-depend-on-other-special-requirements-of-the-AD."><span>Writing rules that depend on other special requirements of the AD.</span></a></li><li><a class="tocitem" href="#Writing-rules-that-are-only-for-your-own-AD"><span>Writing rules that are only for your own AD</span></a></li></ul></li><li><a class="tocitem" href="writing_good_rules.html">Writing Good Rules</a></li><li><a class="tocitem" href="complex.html">Complex Numbers</a></li><li><a class="tocitem" href="arrays.html">Deriving Array Rules</a></li><li><a class="tocitem" href="debug_mode.html">Debug Mode</a></li><li><a class="tocitem" href="gradient_accumulation.html">Gradient Accumulation</a></li><li><a class="tocitem" href="use_in_ad_system.html">Usage in AD</a></li><li><a class="tocitem" href="converting_zygoterules.html">Converting ZygoteRules</a></li><li><span class="tocitem">Design</span><ul><li><a class="tocitem" href="design/changing_the_primal.html">Changing the Primal</a></li><li><a class="tocitem" href="design/many_differentials.html">Many Differential Types</a></li></ul></li><li><a class="tocitem" href="api.html">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href="config.html">Rule configurations and calling back into AD</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="config.html">Rule configurations and calling back into AD</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/JuliaDiff/ChainRulesCore.jl/blob/master/docs/src/config.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="config"><a class="docs-heading-anchor" href="#config">Rule configurations and calling back into AD</a><a id="config-1"></a><a class="docs-heading-anchor-permalink" href="#config" title="Permalink"></a></h1><p><a href="api.html#ChainRulesCore.RuleConfig"><code>RuleConfig</code></a> is a method for making rules conditionally defined based on the presence of certain features in the AD system. One key such feature is the ability to perform AD either in forwards or reverse mode or both.</p><p>This is done with a trait-like system (not Holy Traits), where the <code>RuleConfig</code> has a union of types as its only type-parameter. Where each type represents a particular special feature of this AD. To indicate that the AD system has a special property, its <code>RuleConfig</code> should be defined as:</p><pre><code class="language-julia">struct MyADRuleConfig &lt;: RuleConfig{Union{Feature1, Feature2}} end</code></pre><p>And rules that should only be defined when an AD has a particular special property write:</p><pre><code class="language-julia">rrule(::RuleConfig{&gt;:Feature1}, f, args...) = # rrule that should only be define for ADs with `Feature1`

frule(::RuleConfig{&gt;:Union{Feature1,Feature2}}, f, args...) = # frule that should only be define for ADs with both `Feature1` and `Feature2`</code></pre><p>A prominent use of this is in declaring that the AD system can, or cannot support being called from within the rule definitions.</p><h2 id="Declaring-support-for-calling-back-into-ADs"><a class="docs-heading-anchor" href="#Declaring-support-for-calling-back-into-ADs">Declaring support for calling back into ADs</a><a id="Declaring-support-for-calling-back-into-ADs-1"></a><a class="docs-heading-anchor-permalink" href="#Declaring-support-for-calling-back-into-ADs" title="Permalink"></a></h2><p>To declare support or lack of support for forward and reverse-mode, use the two pairs of complementary types. For reverse mode: <a href="api.html#ChainRulesCore.HasReverseMode"><code>HasReverseMode</code></a>, <a href="api.html#ChainRulesCore.NoReverseMode"><code>NoReverseMode</code></a>. For forwards mode: <a href="api.html#ChainRulesCore.HasForwardsMode"><code>HasForwardsMode</code></a>, <a href="api.html#ChainRulesCore.NoForwardsMode"><code>NoForwardsMode</code></a>. AD systems that support any calling back into AD should have one from each set.</p><p>If an AD <code>HasReverseMode</code>, then it must define <a href="api.html#ChainRulesCore.rrule_via_ad"><code>rrule_via_ad</code></a> for that RuleConfig subtype. Similarly, if an AD <code>HasForwardsMode</code> then it must define <a href="api.html#ChainRulesCore.frule_via_ad"><code>frule_via_ad</code></a> for that RuleConfig subtype.</p><p>For example:</p><pre><code class="language-julia">struct MyReverseOnlyADRuleConfig &lt;: RuleConfig{Union{HasReverseMode, NoForwardsMode}} end

function ChainRulesCore.rrule_via_ad(::MyReverseOnlyADRuleConfig, f, args...)
    ...
    return y, pullback
end</code></pre><p>Note that it is not actually required that the same AD is used for forward and reverse. For example <a href="https://github.com/invenia/Nabla.jl/">Nabla.jl</a> is a reverse mode AD. It might declare that it <code>HasForwardsMode</code>, and then define a wrapper around <a href="https://github.com/JuliaDiff/ForwardDiff.jl">ForwardDiff.jl</a> in order to provide that capacity.</p><h2 id="Writing-rules-that-call-back-into-AD"><a class="docs-heading-anchor" href="#Writing-rules-that-call-back-into-AD">Writing rules that call back into AD</a><a id="Writing-rules-that-call-back-into-AD-1"></a><a class="docs-heading-anchor-permalink" href="#Writing-rules-that-call-back-into-AD" title="Permalink"></a></h2><p>To define e.g. rules for higher order functions, it is useful to be able to call back into the AD system to get it to do some work for you.</p><p>For example the rule for reverse mode AD for <code>map</code> might like to use forward mode AD if one is available. Particularly for the case where only a single input collection is being mapped over. In that case we know the most efficient way to compute that sub-program is in forwards, as each call with-in the map only takes a single input.</p><p>Note: the following is not the most efficient rule for <code>map</code> via forward, but attempts to be clearer for demonstration purposes.</p><pre><code class="language-julia">function rrule(config::RuleConfig{&gt;:HasForwardsMode}, ::typeof(map), f::Function, x::Array{&lt;:Real})
    # real code would support functors/closures, but in interest of keeping example short we exclude it:
    @assert (fieldcount(typeof(f)) == 0) &quot;Functors/Closures are not supported&quot;

    y_and_ẏ = map(x) do xi
        frule_via_ad(config, (NoTangent(), one(xi)), f, xi)
    end
    y = first.(y_and_ẏ)
    ẏ = last.(y_and_ẏ)

    pullback_map(ȳ) = NoTangent(), NoTangent(), ȳ .* ẏ
    return y, pullback_map
end</code></pre><h2 id="Writing-rules-that-depend-on-other-special-requirements-of-the-AD."><a class="docs-heading-anchor" href="#Writing-rules-that-depend-on-other-special-requirements-of-the-AD.">Writing rules that depend on other special requirements of the AD.</a><a id="Writing-rules-that-depend-on-other-special-requirements-of-the-AD.-1"></a><a class="docs-heading-anchor-permalink" href="#Writing-rules-that-depend-on-other-special-requirements-of-the-AD." title="Permalink"></a></h2><p>The <code>&gt;:HasReverseMode</code> and <code>&gt;:HasForwardsMode</code> are two examples of special properties that a <code>RuleConfig</code> could allow. Others could also exist, but right now they are the only two. It is likely that in the future such will be provided for e.g. mutation support.</p><p>Such a thing would look like:</p><pre><code class="language-julia">struct SupportsMutation end

function rrule(
    ::RuleConfig{&gt;:SupportsMutatation}, typeof(push!), x::Vector
)
    y = push!(x)

    function push!_pullback(ȳ)
        pop!(x)  # undo change to primal incase it is used in another pullback we haven&#39;t called yet
        pop!(ȳ)  # accumulate gradient via mutating ȳ, then return ZeroTangent
        return NoTangent(), ZeroTangent()
    end

    return y, push!_pullback
end</code></pre><p>and it would be used in the AD e.g. as follows:</p><pre><code class="language-julia">struct EnzymeRuleConfig &lt;: RuleConfig{Union{SupportsMutation, HasReverseMode, NoForwardsMode}}</code></pre><p>Note: you can only depend on the presence of a feature, not its absence. This means we may need to define features and their compliments, when one is not the obvious default (as in the fast of <a href="api.html#ChainRulesCore.HasReverseMode"><code>HasReverseMode</code></a>/<a href="api.html#ChainRulesCore.NoReverseMode"><code>NoReverseMode</code></a> and <a href="api.html#ChainRulesCore.HasForwardsMode"><code>HasForwardsMode</code></a>/<a href="api.html#ChainRulesCore.NoForwardsMode"><code>NoForwardsMode</code></a>.).</p><p>Such special properties generally should only be defines in <code>ChainRulesCore</code>. (Theoretically, they could be defined elsewhere, but the AD and the package containing the rule need to load them, and ChainRulesCore is the place for things like that.)</p><h2 id="Writing-rules-that-are-only-for-your-own-AD"><a class="docs-heading-anchor" href="#Writing-rules-that-are-only-for-your-own-AD">Writing rules that are only for your own AD</a><a id="Writing-rules-that-are-only-for-your-own-AD-1"></a><a class="docs-heading-anchor-permalink" href="#Writing-rules-that-are-only-for-your-own-AD" title="Permalink"></a></h2><p>A special case of the above is writing rules that are defined only for your own AD. Rules which otherwise would be type-piracy, and would affect other AD systems. This could be done via making up a special property type and dispatching on it. But there is no need, as we can dispatch on the <code>RuleConfig</code> subtype directly.</p><p>For example in order to avoid mutation in nested AD situations, Zygote might want to have a rule for <a href="api.html#ChainRulesCore.add!!"><code>add!!</code></a> that makes it just do <code>+</code>.</p><pre><code class="language-julia">struct ZygoteConfig &lt;: RuleConfig{Union{}} end

rrule(::ZygoteConfig, typeof(ChainRulesCore.add!!), a, b) = a+b, Δ-&gt;(NoTangent(), Δ, Δ)</code></pre><p>As an alternative to rules only for one AD, would be to add new special property definitions to ChainRulesCore (as described above) which would capture what makes that AD special.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="FAQ.html">« FAQ</a><a class="docs-footer-nextpage" href="writing_good_rules.html">Writing Good Rules »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Tuesday 6 July 2021 09:17">Tuesday 6 July 2021</span>. Using Julia version 1.6.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
